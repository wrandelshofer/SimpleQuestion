<?xml version="1.0" encoding="UTF-8"?>
<project name="SimpleQuestion" default="all" basedir="."
         xmlns:if="ant:if"
         xmlns:unless="ant:unless"
         xmlns:fx="javafx:com.sun.javafx.tools.ant"
>
    <target name="init">
        <!-- gobal build properties -->
        <property file="build.properties"/>


        <!-- properties for copyright and versioning -->
        <property name="name" value="${ant.project.name}"/>

        <!-- build properties -->
        <property name="lib" value="lib/compile"/>
        <property name="src" value="src/main/java"/>
        <property name="build" value="build"/>
        <property name="classes" value="${build}/classes"/>
        <property name="dist.dir" value="dist/simplequestion-${version}"/>
        <property name="javadoc" value="dist/SimpleQuestion ${version}/javadoc"/>
        <property name="modulepath" value="${lib}/JHotDraw-7.6"/>

    </target>
    <target name="clean" depends="init">
        <delete dir="${classes}"/>
        <delete dir="${dist.dir}"/>
    </target>
    <target depends="init" description="Javadoc for my API." name="javadoc">
        <mkdir dir="${javadoc}"/>

        <dirset dir="${src}" id="module-dirs">
            <include name="*"/>
        </dirset>
        <pathconvert property="module-names" refid="module-dirs" pathsep=",">
            <map from="${basedir}/${src}/" to=""/>
        </pathconvert>
        <echo message="module-names: ${module-names}"/>

        <exec executable="javadoc">
            <arg line="-header &quot;SimpleQuestion ${version}&quot;"/>
            <arg line="-footer &quot;&lt;font size=-2>Copyright Â© ${author}.&lt;br>${license}.&lt;/font>&quot;"/>
            <arg line="-windowtitle &quot;SimpleQuestion ${version}&quot;"/>
            <arg line="-d &quot;${javadoc}&quot;"/>
            <arg line="--module-source-path &quot;${src}&quot;"/>
            <arg line="--module ${module-names}"/>
        </exec>
    </target>
    <target name="compile" depends="init,clean">
        <mkdir dir="${classes}"/>
        <javac destdir="${classes}"
               modulepath="${modulepath}"
               modulesourcepath="${src}"

               debug="${javac.debug}"
               optimize="${javac.optimize}"
               encoding="${javac.encoding}"
               includeantruntime="${javac.includeantruntime}"
               source="${javac.source}"
               target="${javac.target}"
        >
            <compilerarg value="-version"/>
            <compilerarg value="-Xlint:all"/>
            <include name="**/*.java"/>
        </javac>
        <copy todir="${classes}">
            <fileset dir="${src}">
                <exclude name="**/*.java"/>
                <exclude name="**/.*"/>
            </fileset>
        </copy>
    </target>

    <macrodef name="modular-jar">
        <attribute name="module"/>
        <attribute name="mainclass" default=""/>
        <sequential>
            <mkdir dir="${dist.dir}"/>
            <jar destfile="${dist.dir}/modules/@{module}.jar"
                 basedir="${classes}/@{module}"
            >

                <manifest>
                    <attribute name="Copyright" value="${author}"/>
                    <attribute name="License" value="${license}"/>
                    <attribute name="Implementation-Title" value="@{module}"/>
                    <attribute name="Implementation-Version" value="${version}"/>
                    <attribute name="Implementation-Vendor" value="${author}"/>
                    <attribute name="Specification-Title" value="@{module}"/>
                    <attribute name="Specification-Version" value="${version}"/>
                    <attribute name="Specification-Vendor" value="${author}"/>
                </manifest>
            </jar>
            <exec executable="${jdk10.mac}/bin/jar" unless:blank="@{mainclass}">
                <arg line="-f &quot;${dist.dir}/modules/@{module}.jar&quot;"/>
                <arg line="-u"/>
                <arg line="-e @{mainclass}"/>
            </exec>

            <jar destfile="${dist.dir}/sources/@{module}-src.jar"
                 basedir="${src}/@{module}"
            >
            </jar>
        </sequential>
    </macrodef>
    <target name="run" depends="init">
        <java module="ch.randelshofer.simplequestion" modulepath="${dist.dir}/modules" fork="true">
        </java>
    </target>

    <target name="jar" depends="init,compile,do-jar">
    </target>

    <target name="do-jar" depends="init">
        <modular-jar module="ch.randelshofer.simplequestion" mainclass="ch.randelshofer.simplequestion.Main"/>
        <modular-jar module="org.descheemaecker.nanoxml"/>
        <copy todir="${dist.dir}/modules">
            <fileset dir="${modulepath}">
            <include name="*.jar"/>
            <exclude name=".*"/>
            <exclude name="*-src.jar"/>
            </fileset>
        </copy>
    </target>

    <macrodef name="modular-bundle-mac">
        <attribute name="module"/>
        <attribute name="title"/>
        <attribute name="mainclass" default=""/>
        <sequential>
            <mkdir dir="${dist.dir}/bundles"/>
            <exec executable="${jpackager.mac}">
                <env key="JAVA_HOME" path="${jdk11.mac}"/>
                <arg value="create-installer"/>
                <arg value="--output"/>
                <arg path="${dist.dir}/bundles"/>
                <arg value="--name"/>
                <arg value="@{title}"/>
                <arg value="--module-path"/>
                <arg path="${dist.dir}/modules"/>
                <arg value="--identifier"/>
                <arg value="@{module}"/>
                <arg value="--module"/>
                <arg value="@{module}"/>
                <arg value="--mac-bundle-name"/>
                <arg value="@{title}"/>
                <arg value="--version"/>
                <arg value="${version}"/>
                <arg value="--icon"/>
                <arg value="${app.icon.mac}"/>
            </exec>
        </sequential>
    </macrodef>

    <macrodef name="modular-bundle-win">
        <attribute name="module"/>
        <attribute name="title"/>
        <attribute name="mainclass" default=""/>
        <sequential>
            <mkdir dir="C:/bundles"/>
            <property environment="env"/>
            <exec executable="${jpackager.win}">
                <env key="Path" value="${env.Path};${wix.win}"/>
                <arg value="create-installer"/>
                <arg value="--verbose"/>
                <arg value="--output"/>
                <arg path="${dist.dir}/bundles"/>
                <arg value="--name"/>
                <arg value="@{title}"/>
                <arg value="--module-path"/>
                <arg path="${dist.dir}/modules"/>
                <arg value="--identifier"/>
                <arg value="@{module}"/>
                <arg value="--module"/>
                <arg value="@{module}"/>
                <arg value="--version"/>
                <arg value="${version}"/>
                <arg value="--icon"/>
                <arg value="${app.icon.mac}"/>
            </exec>
        </sequential>
    </macrodef>

    <target name="do-bundle-win" depends="init">
        <property environment="env"/>
        <echo message="bla ${env.Path}"/>
        <taskdef resource="com/sun/javafx/tools/ant/antlib.xml"
                 uri="javafx:com.sun.javafx.tools.ant"
                 classpath="${jdk10.win}/lib/ant-javafx.jar"/>
        <fx:deploy width="800" height="600"
                   nativeBundles="all"
                   outdir="${dist.dir}/bundles" outfile="${name}">
            <fx:application name="${name}"
                            module="ch.randelshofer.simplequestion"
                            mainClass="ch.randelshofer.simplequestion.Main"/>
            <fx:resources>
                <fx:fileset dir="${dist.dir}/modules" includes="*.jar"/>
            </fx:resources>
            <fx:info title="${name}" vendor="${author}"/>
            <fx:runtime>
                <fx:module-path value="${dist.dir}/modules"/>
            </fx:runtime>
        </fx:deploy>
    </target>

    <target name="do-bundle-win-broken" depends="init">
        <modular-bundle-win module="ch.randelshofer.simplequestion" title="${name}"/>
    </target>
    <target name="do-bundle-mac" depends="init">
        <modular-bundle-mac module="ch.randelshofer.simplequestion" title="${name}"/>
    </target>


    <target name="bundle" depends="jar,do-bundle-mac">
    </target>

    <target name="dist" depends="bundle">
    </target>

</project>
